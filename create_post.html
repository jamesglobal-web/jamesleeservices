<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Post</title>
</head>
<body>
    <h1>Create Post</h1>
    <form id="postForm">
        <input type="text" id="title" placeholder="Title" required>
        <textarea id="content" placeholder="Content" required></textarea>
        <button type="submit">Post</button>
    </form>
    <div id="postList"></div>

    <!-- Firebase setup -->
    <script src="https://www.gstatic.com/firebasejs/9.x/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x/firebase-firestore.js"></script>
    <script>
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyDyARFkXIaIbZaSKcjndPtfNr8VkzjiXeQ",
        authDomain: "prospera-1620c.firebaseapp.com",
        projectId: "prospera-1620c",
        storageBucket: "prospera-1620c.appspot.com",
        messagingSenderId: "3420982464",
        appId: "1:34209824640:web:051f6c02741d8c218d4b65",
      };

      // Initialize Firebase
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
    </script>

    <script>
        const postForm = document.getElementById('postForm');
        const postList = document.getElementById('postList');

        // Check if the user is the owner and email is verified
        auth.onAuthStateChanged(user => {
            if (user) {
                if (user.email === "owner@example.com" && user.emailVerified) {
                    loadPosts();
                } else {
                    alert("Access Denied! Only the verified owner can create posts.");
                    window.location.href = "news.html";
                }
            } else {
                alert("Please log in as the owner to create posts.");
                window.location.href = "news.html";
            }
        });

        // Add a new post
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();

            if (!title || !content) {
                alert("Title and content cannot be empty.");
                return;
            }

            try {
                await db.collection('news').add({
                    title: title,
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("Post added successfully!");
                postForm.reset();
                loadPosts();
            } catch (error) {
                console.error("Error adding post:", error);
                alert("Failed to add post. Please try again.");
            }
        });

        // Load posts for editing/deleting
        async function loadPosts() {
            postList.innerHTML = "";
            try {
                const snapshot = await db.collection('news').orderBy('timestamp', 'desc').get();
                if (snapshot.empty) {
                    postList.innerHTML = "<p>No posts available.</p>";
                    return;
                }

                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postItem = document.createElement('div');
                    postItem.innerHTML = `
                        <h2>${sanitizeHTML(post.title)}</h2>
                        <p>${sanitizeHTML(post.content)}</p>
                        <button onclick="editPost('${doc.id}', '${sanitizeHTML(post.title)}', '${sanitizeHTML(post.content)}')">Edit</button>
                        <button onclick="deletePost('${doc.id}')">Delete</button>
                        <hr>
                    `;
                    postList.appendChild(postItem);
                });
            } catch (error) {
                console.error("Error loading posts:", error);
                postList.innerHTML = "<p>Error loading posts. Please try again.</p>";
            }
        }

        // Edit a post
        async function editPost(id, title, content) {
            const newTitle = prompt("Edit Title:", title);
            const newContent = prompt("Edit Content:", content);
            if (newTitle && newContent) {
                try {
                    await db.collection('news').doc(id).update({
                        title: newTitle,
                        content: newContent
                    });
                    alert("Post updated!");
                    loadPosts();
                } catch (error) {
                    console.error("Error updating post:", error);
                    alert("Failed to update post. Please try again.");
                }
            }
        }

        // Delete a post
        async function deletePost(id) {
            if (confirm("Are you sure you want to delete this post?")) {
                try {
                    await db.collection('news').doc(id).delete();
                    alert("Post deleted!");
                    loadPosts();
                } catch (error) {
                    console.error("Error deleting post:", error);
                    alert("Failed to delete post. Please try again.");
                }
            }
        }

        // Function to sanitize HTML to prevent XSS
        function sanitizeHTML(text) {
            const element = document.createElement('div');
            element.innerText = text;
            return element.innerHTML;
        }
    </script>
</body>
</html>
